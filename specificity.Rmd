---
title: "Additional analyses"
author: "Alejandro Cisterna"
date: "June 15, 2022"
output:
  html_document:
    code_folding: hide
    theme: spacelab
    highlight: kate
    df_print: paged
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

knitr::opts_chunk$set(echo = TRUE , warning= FALSE, message=FALSE, fig.width=12, fig.height=8)

library(dplyr)
library (tibble)
library (ggplot2)
library (pROC)
library (reshape)
library(readr)
library(readxl)
library(doParallel)
library(stringr)
library(plyr)
library(tidyverse)
library(data.table)
library(glmnet)
library(InformationValue)
library(entropy)
library(ggcorrplot)
library(lares)
library(corrr)
library(ggpubr)
library(kableExtra)
library(scales)
library(beeswarm)
library(ggbeeswarm)
library(enrichR)
library(biomaRt)
library(kit)
library(reshape2)
library(gridExtra)
library(grid)
library(corrplot)
library("PerformanceAnalytics")
library(pROC)
library(MLeval)
library(caret)
library(plotROC)
library(RColorBrewer)
library(ggrepel)
library(ggvenn)
library(PRROC)
library(GeneOverlap)

```



# Specificity ROC

## Scale two sets function

First, we need to rescale each column in the testing datasets for specifity analyses to the same range (Min, Max) in the training population.

```{r}
i = 1

scaletwosets = function(trainingreference, dftoscale){
  
  # As data frame
  trainingreference = as.data.frame(trainingreference)
  dftoscale = as.data.frame(dftoscale)
  
  
  columnscommon = which(colnames(trainingreference) %in% colnames(dftoscale))


  trainingreference = trainingreference[,columnscommon]
  
  # Make data frame with the same number of rows and columns
  dfscalated = data.frame(matrix(0, nrow = nrow(dftoscale), ncol = ncol(dftoscale),
                              dimnames = list(NULL, colnames(dftoscale))) )

  
      for(i in 1:length(colnames(trainingreference))){
        
      # Compute max and min for each feature in the training reference
      df1range = NULL
      df1range = range(trainingreference[,i])
      df1rangemin = df1range[1]
      df1rangemax = df1range[2]
      
      # Scale to this min and max the values in the dftoscale
      vec_range <- rescale(dftoscale[,i], to = c(df1rangemin, df1rangemax))
      dfscalated[,i] = vec_range
      
    }

  return(dfscalated)

}

```


## 220 genes

```{r}

genestodoml220 = fread("220genes.csv")

genestodoml220 = genestodoml220$ENSG

genestodoml = genestodoml220

# Load Matrix
matrix_phase = readRDS("matrix_rlogk99qcADPreclinicalandControls_sex_agep_notion")
train = matrix_phase


# Select features
genestodoml = c(genestodoml, "Status")
commontrain = colnames(train) %in% genestodoml
train = train[,..commontrain]



# Select only genes
x_train <- train[,-1]

# Compute Z score



modelo_means <- as.data.frame(lapply(x_train, mean))
modelo_sd <- as.data.frame(lapply(x_train, sd))



```




### Load AD model PreClinical


```{r}

genestodoml = genestodoml220

genestodoml = c(genestodoml, "Status")

 
# Load Matrix
matrix_phase = readRDS("matrix_rlogk99qcADPreclinicalandControls_sex_agep_notion")
train = matrix_phase

trainconpred = train



# Select features
genestodoml = c(genestodoml, "Status")
commontrain = colnames(train) %in% genestodoml
train = train[,..commontrain]



# Select only genes
x_train <- train[,-1]

# Compute Z score
x_train <- as.data.frame(lapply(x_train, function(x) (x - mean(x))/sd(x) ))
x_train <- as.matrix(x_train )

# Code status
numeros = as.numeric(train$Status)
y_train <-replace(numeros, numeros == 2,0)


y_train_220 = y_train 

# Set seed
set.seed(123)

# Train ridge
cv_error <- cv.glmnet(
  x      = x_train,
  y      = factor(y_train),
  alpha  = 0,
  nfolds = 5, #
  type.measure = "mse",
  standardize  = F,
  family = "binomial",
  intercept = F
)



# Best model lambda
modelo <- glmnet(
  x           = x_train,
  y           = y_train,
  alpha       = 0,
  lambda      = cv_error$lambda.min,
  standardize = F,
  family = "binomial",
  intercept = F
)


# Training predictions
# ==============================================================================
predicciones_train_220 <- predict(modelo, newx = x_train, type = "response", standardize = F)




genestodoml = genestodoml220
genestodoml = c(genestodoml, "Status")
# Load Matrix
test = readRDS("rlogmatrix_allpsold38qcp_notion")


tocorrelationtest = test[,c(1,2,3,4,6)]


# Select features
commontest = colnames(test) %in% genestodoml
test = test[,commontest]




# Select only genes
x_test <- test[,-1]

# Compute Z score
x_test <- as.data.frame(lapply(x_test, function(x) (x - mean(x))/sd(x) ))
x_test <- as.matrix(x_test )

# Code status
numeros = as.numeric(test$Status)
y_test <-replace(numeros, numeros == 1,0)
y_test <-replace(y_test, y_test == 2,1)
# y_test <-replace(numeros, numeros == 1,0)
# y_test <-replace(y_test, y_test == 2,1)


y_test_220 = y_test


# Testing preditions
# ==============================================================================
predicciones_test <- predict(modelo, newx = x_test, type = "response" , standarize = F, intercept = F)

predicciones_test_220 = predicciones_test





# Model220 roc comes from above code (220 genes model)

model220rocte = as.data.frame(y_test_220)
model220rocte$predictor = predicciones_test_220
model220rocte$model = "220 genes (AUC = 0.97)"


names(model220rocte) = c("status", "predictor", "Classifier")



model220roctr = as.data.frame(y_train_220)
model220roctr$predictor = predicciones_train_220
model220roctr$model = "220 genes (AUC = 0.97)"

names(model220roctr) = c("status", "predictor", "Classifier")



model220rocspe = rbind(model220rocte,model220roctr)

# Extract control samples

controlsforspe = model220rocspe[model220rocspe$status == 0,]

  # Add this dataset to the final

    
    
```


### Specificity PD individuals

Scale PD individuals:

```{r}

genestodoml = genestodoml220

# Load Matrix
matrix_phase = readRDS("matrix_rlogk99qcADPreclinicalandControls_sex_agep_notion")
train = matrix_phase


# Select features
genestodoml = c(genestodoml, "Status")
commontrain = colnames(train) %in% genestodoml
train = train[,..commontrain]



# Select only genes
x_train <- train[,-1]



# Para el dftoscale
test = readRDS("matrix_dod_sex_age_notion")

test = subset(test, test$Status == "PD")

commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes
x_test <- test[,-1]


# Esto es una prueba
#pdscaleprueba = scale(x_test, center = F, scale = c(0,1))

pdscalated = scaletwosets(x_train, x_test)


PDmatrix_means <- as.data.frame(lapply(pdscalated, mean))


```


Obtain PD prediction values:  


```{r}

genestodoml = genestodoml220

genestodoml = c(genestodoml, "Status")


test = readRDS("matrix_dod_sex_age_notion")
test = subset(test, test$Status == "PD")

commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes
x_test <- pdscalated


#dfmodelomenas = as.data.frame(modelo_means[col(x_test[])])

x_testprueba = x_test[]-modelo_means[col(x_test[])]

x_testpruebafinal = x_testprueba[]/modelo_sd[col(x_testprueba[])]

x_test = x_testpruebafinal

x_test = as.data.frame(x_test)



# add gene name from cdr05
#x_test = cbind(x_test, setNames( lapply(genesnoaparecen, function(x) x=0), genesnoaparecen) )
x_test <- as.matrix(x_test )



# Code status
numeros = as.numeric(test$Status)
 y_test <-replace(numeros, numeros == 1,0)
 y_test <-replace(y_test, y_test == 2,1)

 y_test_pd = y_test
 
 pdtoeatmap = as.data.frame(x_test)


# Testing preditions
# ==============================================================================
predicciones_test <- predict(modelo, newx = x_test, type = "response" , standarize = F, intercept = F) 

 predicciones_test_pd = predicciones_test
 
 
 
 
 
 
 
model220pd = as.data.frame(y_test_pd)
model220pd$predictor = predicciones_test_pd
model220pd$model = "220 genes PD (AUC = )"

names(model220pd) = c("status", "predictor", "Classifier")
 
 
 model220pd = rbind(model220pd,controlsforspe)
 
 model220pd$Classifier = "220 genes PD (AUC = 0.72)"

 
 
 longspe220 =rbind(model220pd, model220rocspe)
 
 
 longspe220$Classifier = as.factor(longspe220$Classifier)

# longmodelroc$Classifier <- factor(longmodelroc$Classifier, levels = c("40 genes (AUC = 0.90)", "90 genes (AUC = 0.92)", "220 genes (AUC = 0.94)"))

#set colors
ejemplocolores = brewer.pal(12, "Paired")[1:12]

# "#A6CEE3" "#1F78B4" "#B2DF8A" "#33A02C" "#FB9A99" "#E31A1C" "#FDBF6F" "#FF7F00" "#CAB2D6" "#6A3D9A" "#FFFF99" "#B15928"

colors =c("#E31A1C", "#1F78B4")
colors<-setNames(colors[1:nlevels(longspe220$Classifier)], levels(longspe220$Classifier))



## draw plots
basicplot <- ggplot(longspe220, aes(d = status, m = predictor, color = Classifier)) + geom_roc(n.cuts = 0) +   style_roc(theme = theme_bw, xlab = "1-Specificity", ylab = "Sensitivity") + geom_abline(slope = 1, intercept = 0, lty = 2, colour = 'black') + 
    scale_colour_manual(values=colors) 

## calculate auc
# De aqui es de donde coges el AUC para cada uno
calc_auc(basicplot)

basicplot 


# PR curves?? cuando hago esto es menor
# xcurve = pr.curve(scores.class0 = controlsforspe$predictor, scores.class1 = model220pd$predictor, curve=T)
# plot(xcurve)





```



### Specificity DLB individuals

Scale DLB individuals:  


```{r}

genestodoml = genestodoml220

# Load Matrix
matrix_phase = readRDS("matrix_rlogk99qcADPreclinicalandControls_sex_agep_notion")
train = matrix_phase


# Select features
genestodoml = c(genestodoml, "Status")
commontrain = colnames(train) %in% genestodoml
train = train[,..commontrain]

# Select only genes
x_train <- train[,-1]




test = readRDS("matrix_ethnicqc_sex_age_notion")

genestodoml = c(genestodoml, "Status")

test = subset(test, test$Status == "DLB")


commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes
x_test <- test[,-1]


dlbscalated = scaletwosets(x_train, x_test)



```



```{r}



genestodoml = c(genestodoml, "Status")

# Load Matrix
test = readRDS("matrix_ethnicqc_sex_age_notion")


genesgenestodoml = as.data.frame(genestodoml)
colnames(genesgenestodoml) = "gene"

# Select features
commontest = colnames(test) %in% genestodoml
test = test[,..commontest]

nombrestest = as.data.frame(colnames(test))
colnames(nombrestest) = "gene"


genesnoaparecen = anti_join(genesgenestodoml,nombrestest)
genesnoaparecen = as.character(genesnoaparecen$gene)

test = readRDS("matrix_ethnicqc_sex_age_notion")

genestodoml = c(genestodoml, "Status")

test = subset(test, test$Status == "DLB")


commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes and the scalated df
x_test <- dlbscalated

modelo_meansftdp = modelo_means

which(colnames(modelo_meansftdp) %in% genesnoaparecen)  

modelo_meansftd = modelo_meansftdp[,-c(170,178)]

modelo_sdftdp = modelo_sd

modelo_sdftdpd = modelo_sdftdp[,-c(170,178)]


x_testprueba = x_test[]-modelo_meansftd[col(x_test[])]

x_testpruebafinal = x_testprueba[]/modelo_sdftdpd[col(x_testprueba[])]

x_test = x_testpruebafinal

x_test = as.data.frame(x_test)

 # add gene name from cdr05
x_test = cbind(x_test, setNames( lapply(genesnoaparecen, function(x) x=0), genesnoaparecen))

x_test <- as.matrix(x_test )

dlbtoeatmap = as.data.frame(x_test)

# Code status
numeros = as.numeric(test$Status)
 y_test <-replace(numeros, numeros == 2,1)


y_test_dlb = y_test

# Testing preditions
# ==============================================================================
predicciones_test <- predict(modelo, newx = x_test, type = "response" , standarize = F, intercept = F) 

 
 predicciones_test_dlb = predicciones_test
 
model220dlb = as.data.frame(y_test_dlb)
model220dlb$predictor = predicciones_test_dlb
model220dlb$model = "220 genes DLB (AUC = )"

names(model220dlb) = c("status", "predictor", "Classifier")
 
 
 model220dlb = rbind(model220dlb,controlsforspe)
 
 model220dlb$Classifier = "220 genes DLB (AUC = 0.88)"

 
 
 longspe220 =rbind(longspe220, model220dlb)

```




### Specificity FTD individuals

Scale FTD individuals:  


```{r}

genestodoml = genestodoml220

# Load Matrix
matrix_phase = readRDS("matrix_rlogk99qcADPreclinicalandControls_sex_agep_notion")
train = matrix_phase


# Select features
genestodoml = c(genestodoml, "Status")
commontrain = colnames(train) %in% genestodoml
train = train[,..commontrain]

# Select only genes
x_train <- train[,-1]




test = readRDS("matrix_ethnicqc_sex_age_notion")

genestodoml = c(genestodoml, "Status")

test = subset(test, test$Status == "FTD")


commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes
x_test <- test[,-1]


ftdscalated = scaletwosets(x_train, x_test)



```



```{r}



genestodoml = c(genestodoml, "Status")

# Load Matrix
test = readRDS("matrix_ethnicqc_sex_age_notion")


genesgenestodoml = as.data.frame(genestodoml)
colnames(genesgenestodoml) = "gene"

# Select features
commontest = colnames(test) %in% genestodoml
test = test[,..commontest]

nombrestest = as.data.frame(colnames(test))
colnames(nombrestest) = "gene"


genesnoaparecen = anti_join(genesgenestodoml,nombrestest)
genesnoaparecen = as.character(genesnoaparecen$gene)

test = readRDS("matrix_ethnicqc_sex_age_notion")

genestodoml = c(genestodoml, "Status")

test = subset(test, test$Status == "FTD")


commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes and the scalated df
x_test <- ftdscalated

modelo_meansftdp = modelo_means

modelo_meansftd = modelo_meansftdp[,-c(170,178)]

modelo_sdftdp = modelo_sd

modelo_sdftdpd = modelo_sdftdp[,-c(170,178)]


x_testprueba = x_test[]-modelo_meansftd[col(x_test[])]

x_testpruebafinal = x_testprueba[]/modelo_sdftdpd[col(x_testprueba[])]

x_test = x_testpruebafinal

x_test = as.data.frame(x_test)

 # add gene name from cdr05
x_test = cbind(x_test, setNames( lapply(genesnoaparecen, function(x) x=0), genesnoaparecen))

x_test <- as.matrix(x_test )

ftdtoeatmap = as.data.frame(x_test)

# Code status
numeros = as.numeric(test$Status)
 y_test <-replace(numeros, numeros == 2,1)


y_test_ftd = y_test

# Testing preditions
# ==============================================================================
predicciones_test <- predict(modelo, newx = x_test, type = "response" , standarize = F, intercept = F) 

 
 
 predicciones_test_ftd = predicciones_test
 
model220ftd = as.data.frame(y_test_ftd)
model220ftd$predictor = predicciones_test_ftd
model220ftd$model = "220 genes FTD (AUC = )"

names(model220ftd) = c("status", "predictor", "Classifier")
 
 
 model220ftd = rbind(model220ftd,controlsforspe)
 
 model220ftd$Classifier = "220 genes FTD (AUC = 0.93)"

 
 
 longspe220 =rbind(longspe220, model220ftd)


```
 
 
### Figure
 
 
```{r}
 
  longspe220$Classifier = as.factor(longspe220$Classifier)
 
  longspe220$Classifier <- factor(longspe220$Classifier, levels = c("220 genes (AUC = 0.97)","220 genes PD (AUC = 0.72)","220 genes DLB (AUC = 0.88)","220 genes FTD (AUC = 0.93)"))
 

colors =c("#B2DF8A", "#9A031E", "#A1A7B8", "#F1C232")
colors<-setNames(colors[1:nlevels(longspe220$Classifier)], levels(longspe220$Classifier))



## draw plots
basicplot <- ggplot(longspe220, aes(d = status, m = predictor, color = Classifier)) + geom_roc(n.cuts = 0) +   style_roc(theme = theme_bw, xlab = "1-Specificity", ylab = "Sensitivity") + geom_abline(slope = 1, intercept = 0, lty = 2, colour = 'black') + 
    scale_colour_manual(values=colors) 

## calculate auc
# De aqui es de donde coges el AUC para cada uno
calc_auc(basicplot)

basicplot

  ggsave(filename = "roccurvesspecificity.png",
        plot = basicplot,
        device = "png",
        width =10,
        height = 8,
        dpi = 600)
  
    # PD
  
  preadconfusion = longspe220[longspe220$Classifier == "220 genes PD (AUC = 0.72)",]
  
  
caret::confusionMatrix(data = factor(as.numeric(preadconfusion$predictor>0.5)), reference = factor(preadconfusion$status))
  
    # dlb
  
  preadconfusion = longspe220[longspe220$Classifier == "220 genes DLB (AUC = 0.88)",]
  
  
caret::confusionMatrix(data = factor(as.numeric(preadconfusion$predictor>0.5)), reference = factor(preadconfusion$status))


 # ftd
  
  preadconfusion = longspe220[longspe220$Classifier == "220 genes FTD (AUC = 0.93)",]
  
  
caret::confusionMatrix(data = factor(as.numeric(preadconfusion$predictor>0.5)), reference = factor(preadconfusion$status))

 
```



 
### Figure diff

Anova de diferencia de medias? t.test? 
 
```{r}

longspe220diff = longspe220

longspe220diff1 =longspe220diff[longspe220diff$status == 1,]

adas1 = longspe220diff1[longspe220diff1$Classifier == "220 genes (AUC = 0.97)",]

pdas0 = longspe220diff1[longspe220diff1$Classifier == "220 genes PD (AUC = 0.72)",]

pdas0$status = 0

rocdifpd = rbind(adas1,pdas0)

rocdifpd$Classifier = "220 genes AD vs PD (AUC = 0.81)"

 
dlbas0 = longspe220diff1[longspe220diff1$Classifier == "220 genes DLB (AUC = 0.88)",]

dlbas0$status = 0

rocdifdlb = rbind(adas1,dlbas0)

rocdifdlb$Classifier = "220 genes AD vs DLB (AUC = 0.69)"

ftdas0 = longspe220diff1[longspe220diff1$Classifier == "220 genes FTD (AUC = 0.93)",]

ftdas0$status = 0

rocdifftd = rbind(adas1,ftdas0)

rocdifftd$Classifier = "220 genes AD vs FTD (AUC = 0.76)"


rocdifto = rbind(rocdifpd,rocdifdlb)

rocdifto = rbind(rocdifto,rocdifftd)

 
  rocdifto$Classifier = as.factor(rocdifto$Classifier)
 
  rocdifto$Classifier <- factor(rocdifto$Classifier, levels = c("220 genes AD vs PD (AUC = 0.81)","220 genes AD vs DLB (AUC = 0.69)","220 genes AD vs FTD (AUC = 0.76)"))
 

colors =c("#9A031E", "#A1A7B8", "#F1C232")
colors<-setNames(colors[1:nlevels(rocdifto$Classifier)], levels(rocdifto$Classifier))



## draw plots
basicplot <- ggplot(rocdifto, aes(d = status, m = predictor, color = Classifier)) + geom_roc(n.cuts = 0) +   style_roc(theme = theme_bw, xlab = "1-Specificity", ylab = "Sensitivity") + geom_abline(slope = 1, intercept = 0, lty = 2, colour = 'black') + 
    scale_colour_manual(values=colors) 

## calculate auc
# De aqui es de donde coges el AUC para cada uno
calc_auc(basicplot)

basicplot

  ggsave(filename = "roccurvesspecificityvs.png",
        plot = basicplot,
        device = "png",
        width =10,
        height = 8,
        dpi = 600)
  
  
  
  # PD diferencias significativas por t.test
  t.test(adas1$predictor, pdas0$predictor)
  
  # DLB diferencias signivicativas
  t.test(adas1$predictor, dlbas0$predictor)
  
  
  # FTD  difenrencias significativas
  t.test(adas1$predictor, ftdas0$predictor)
 
```


### Figure PR-curve

Hacer precission recall curve o definir un valor en la curva que sea el treshold de 0.5

```{r}

xcurve = pr.curve(scores.class0 = controlsforspe$predictor, scores.class1 = adas1$predictor, curve=T)

xcurve3 = pr.curve(scores.class0 = controlsforspe$predictor, scores.class1 = model220dlb$predictor, curve=T)
plot(xcurve)
plot(xcurve3, add=TRUE, color="green")



# and compute the PR curve
pr.2<-pr.curve(scores.class0 = scores.2, weights.class0 = weights, curve = TRUE)
# plot all three curves for the first classifier in red
plot(pr, max.plot = TRUE, min.plot = TRUE, rand.plot = TRUE, fill.area = TRUE, 
  color="red", auc.main=FALSE)
# and add the curve for the second classifier
plot(pr.2, add=TRUE, color="green")

```



## 40 genes



```{r}

genestodoml40 = fread("40genes.csv")

genestodoml40 = genestodoml40[-1,1]
genestodoml40 = genestodoml40$V1

genestodoml = genestodoml40

# Load Matrix
matrix_phase = readRDS("matrix_rlogk99qcADPreclinicalandControls_sex_agep_notion")
train = matrix_phase


# Select features
genestodoml = c(genestodoml, "Status")
commontrain = colnames(train) %in% genestodoml
train = train[,..commontrain]



# Select only genes
x_train <- train[,-1]

# Compute Z score



modelo_means <- as.data.frame(lapply(x_train, mean))
modelo_sd <- as.data.frame(lapply(x_train, sd))



```




### Load AD model PreClinical


```{r}

genestodoml = genestodoml40

genestodoml = c(genestodoml, "Status")

 
# Load Matrix
matrix_phase = readRDS("matrix_rlogk99qcADPreclinicalandControls_sex_agep_notion")
train = matrix_phase

trainconpred = train



# Select features
genestodoml = c(genestodoml, "Status")
commontrain = colnames(train) %in% genestodoml
train = train[,..commontrain]



# Select only genes
x_train <- train[,-1]

# Compute Z score
x_train <- as.data.frame(lapply(x_train, function(x) (x - mean(x))/sd(x) ))
x_train <- as.matrix(x_train )

# Code status
numeros = as.numeric(train$Status)
y_train <-replace(numeros, numeros == 2,0)


y_train_40 = y_train 

# Set seed
set.seed(123)

# Train ridge
cv_error <- cv.glmnet(
  x      = x_train,
  y      = factor(y_train),
  alpha  = 0,
  nfolds = 5, #
  type.measure = "mse",
  standardize  = F,
  family = "binomial",
  intercept = F
)



# Best model lambda
modelo <- glmnet(
  x           = x_train,
  y           = y_train,
  alpha       = 0,
  lambda      = cv_error$lambda.min,
  standardize = F,
  family = "binomial",
  intercept = F
)


# Training predictions
# ==============================================================================
predicciones_train_40 <- predict(modelo, newx = x_train, type = "response", standardize = F)




genestodoml = genestodoml40
genestodoml = c(genestodoml, "Status")
# Load Matrix
test = readRDS("rlogmatrix_allpsold38qcp_notion")


tocorrelationtest = test[,c(1,2,3,4,6)]


# Select features
commontest = colnames(test) %in% genestodoml
test = test[,commontest]




# Select only genes
x_test <- test[,-1]

# Compute Z score
x_test <- as.data.frame(lapply(x_test, function(x) (x - mean(x))/sd(x) ))
x_test <- as.matrix(x_test )

# Code status
numeros = as.numeric(test$Status)
y_test <-replace(numeros, numeros == 1,0)
y_test <-replace(y_test, y_test == 2,1)
# y_test <-replace(numeros, numeros == 1,0)
# y_test <-replace(y_test, y_test == 2,1)


y_test_40 = y_test


# Testing preditions
# ==============================================================================
predicciones_test <- predict(modelo, newx = x_test, type = "response" , standarize = F, intercept = F)

predicciones_test_40 = predicciones_test





# Model40 roc comes from above code (40 genes model)

model40rocte = as.data.frame(y_test_40)
model40rocte$predictor = predicciones_test_40
model40rocte$model = "40 genes (AUC = 0.96)"


names(model40rocte) = c("status", "predictor", "Classifier")



model40roctr = as.data.frame(y_train_40)
model40roctr$predictor = predicciones_train_40
model40roctr$model = "40 genes (AUC = 0.96)"

names(model40roctr) = c("status", "predictor", "Classifier")



model40rocspe = rbind(model40rocte,model40roctr)

# Extract control samples

controlsforspe = model40rocspe[model40rocspe$status == 0,]

  # Add this dataset to the final

    
    
```


### Specificity PD individuals

Scale PD individuals:

```{r}

genestodoml = genestodoml40

# Load Matrix
matrix_phase = readRDS("matrix_rlogk99qcADPreclinicalandControls_sex_agep_notion")
train = matrix_phase


# Select features
genestodoml = c(genestodoml, "Status")
commontrain = colnames(train) %in% genestodoml
train = train[,..commontrain]



# Select only genes
x_train <- train[,-1]



# Para el dftoscale
test = readRDS("matrix_dod_sex_age_notion")

test = subset(test, test$Status == "PD")

commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes
x_test <- test[,-1]


# Esto es una prueba
#pdscaleprueba = scale(x_test, center = F, scale = c(0,1))

pdscalated = scaletwosets(x_train, x_test)


PDmatrix_means <- as.data.frame(lapply(pdscalated, mean))


```


Obtain PD prediction values:  


```{r}

genestodoml = genestodoml40

genestodoml = c(genestodoml, "Status")


test = readRDS("matrix_dod_sex_age_notion")
test = subset(test, test$Status == "PD")

commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes
x_test <- pdscalated


#dfmodelomenas = as.data.frame(modelo_means[col(x_test[])])

x_testprueba = x_test[]-modelo_means[col(x_test[])]

x_testpruebafinal = x_testprueba[]/modelo_sd[col(x_testprueba[])]

x_test = x_testpruebafinal

x_test = as.data.frame(x_test)



# add gene name from cdr05
#x_test = cbind(x_test, setNames( lapply(genesnoaparecen, function(x) x=0), genesnoaparecen) )
x_test <- as.matrix(x_test )



# Code status
numeros = as.numeric(test$Status)
 y_test <-replace(numeros, numeros == 1,0)
 y_test <-replace(y_test, y_test == 2,1)

 y_test_pd = y_test
 
 pdtoeatmap = as.data.frame(x_test)


# Testing preditions
# ==============================================================================
predicciones_test <- predict(modelo, newx = x_test, type = "response" , standarize = F, intercept = F) 

 predicciones_test_pd = predicciones_test
 
 
 
 
 
 
 
model40pd = as.data.frame(y_test_pd)
model40pd$predictor = predicciones_test_pd
model40pd$model = "40 genes PD (AUC = )"

names(model40pd) = c("status", "predictor", "Classifier")
 
 
 model40pd = rbind(model40pd,controlsforspe)
 
 model40pd$Classifier = "40 genes PD (AUC = 0.65)"

 
 
 longspe40 =rbind(model40pd, model40rocspe)
 
 
 longspe40$Classifier = as.factor(longspe40$Classifier)

# longmodelroc$Classifier <- factor(longmodelroc$Classifier, levels = c("40 genes (AUC = 0.90)", "90 genes (AUC = 0.92)", "40 genes (AUC = 0.94)"))

#set colors
ejemplocolores = brewer.pal(12, "Paired")[1:12]

# "#A6CEE3" "#1F78B4" "#B2DF8A" "#33A02C" "#FB9A99" "#E31A1C" "#FDBF6F" "#FF7F00" "#CAB2D6" "#6A3D9A" "#FFFF99" "#B15928"

colors =c("#E31A1C", "#1F78B4")
colors<-setNames(colors[1:nlevels(longspe40$Classifier)], levels(longspe40$Classifier))



## draw plots
basicplot <- ggplot(longspe40, aes(d = status, m = predictor, color = Classifier)) + geom_roc(n.cuts = 0) +   style_roc(theme = theme_bw, xlab = "1-Specificity", ylab = "Sensitivity") + geom_abline(slope = 1, intercept = 0, lty = 2, colour = 'black') + 
    scale_colour_manual(values=colors) 

## calculate auc
# De aqui es de donde coges el AUC para cada uno
calc_auc(basicplot)

basicplot 


# PR curves?? cuando hago esto es menor
# xcurve = pr.curve(scores.class0 = controlsforspe$predictor, scores.class1 = model40pd$predictor, curve=T)
# plot(xcurve)





```



### Specificity DLB individuals

Scale DLB individuals:  


```{r}

genestodoml = genestodoml40

# Load Matrix
matrix_phase = readRDS("matrix_rlogk99qcADPreclinicalandControls_sex_agep_notion")
train = matrix_phase


# Select features
genestodoml = c(genestodoml, "Status")
commontrain = colnames(train) %in% genestodoml
train = train[,..commontrain]

# Select only genes
x_train <- train[,-1]




test = readRDS("matrix_ethnicqc_sex_age_notion")

genestodoml = c(genestodoml, "Status")

test = subset(test, test$Status == "DLB")


commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes
x_test <- test[,-1]


dlbscalated = scaletwosets(x_train, x_test)



```



```{r}



genestodoml = c(genestodoml, "Status")

# Load Matrix
test = readRDS("matrix_ethnicqc_sex_age_notion")


genesgenestodoml = as.data.frame(genestodoml)
colnames(genesgenestodoml) = "gene"

# Select features
commontest = colnames(test) %in% genestodoml
test = test[,..commontest]

nombrestest = as.data.frame(colnames(test))
colnames(nombrestest) = "gene"


genesnoaparecen = anti_join(genesgenestodoml,nombrestest)
genesnoaparecen = as.character(genesnoaparecen$gene)

test = readRDS("matrix_ethnicqc_sex_age_notion")

genestodoml = c(genestodoml, "Status")

test = subset(test, test$Status == "DLB")


commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes and the scalated df
x_test <- dlbscalated

modelo_meansftdp = modelo_means

which(colnames(modelo_meansftdp) %in% genesnoaparecen)  

modelo_meansftd = modelo_meansftdp[,-c(170,178)]

modelo_sdftdp = modelo_sd

modelo_sdftdpd = modelo_sdftdp[,-c(170,178)]


x_testprueba = x_test[]-modelo_meansftd[col(x_test[])]

x_testpruebafinal = x_testprueba[]/modelo_sdftdpd[col(x_testprueba[])]

x_test = x_testpruebafinal

x_test = as.data.frame(x_test)

 # add gene name from cdr05
# x_test = cbind(x_test, setNames( lapply(genesnoaparecen, function(x) x=0), genesnoaparecen))

x_test <- as.matrix(x_test )

dlbtoeatmap = as.data.frame(x_test)

# Code status
numeros = as.numeric(test$Status)
 y_test <-replace(numeros, numeros == 2,1)


y_test_dlb = y_test

# Testing preditions
# ==============================================================================
predicciones_test <- predict(modelo, newx = x_test, type = "response" , standarize = F, intercept = F) 

 
 predicciones_test_dlb = predicciones_test
 
model40dlb = as.data.frame(y_test_dlb)
model40dlb$predictor = predicciones_test_dlb
model40dlb$model = "40 genes DLB (AUC = )"

names(model40dlb) = c("status", "predictor", "Classifier")
 
 
 model40dlb = rbind(model40dlb,controlsforspe)
 
 model40dlb$Classifier = "40 genes DLB (AUC = 0.85)"

 
 
 longspe40 =rbind(longspe40, model40dlb)

```




### Specificity FTD individuals

Scale FTD individuals:  


```{r}

genestodoml = genestodoml40

# Load Matrix
matrix_phase = readRDS("matrix_rlogk99qcADPreclinicalandControls_sex_agep_notion")
train = matrix_phase


# Select features
genestodoml = c(genestodoml, "Status")
commontrain = colnames(train) %in% genestodoml
train = train[,..commontrain]

# Select only genes
x_train <- train[,-1]




test = readRDS("matrix_ethnicqc_sex_age_notion")

genestodoml = c(genestodoml, "Status")

test = subset(test, test$Status == "FTD")


commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes
x_test <- test[,-1]


ftdscalated = scaletwosets(x_train, x_test)



```



```{r}



genestodoml = c(genestodoml, "Status")

# Load Matrix
test = readRDS("matrix_ethnicqc_sex_age_notion")


genesgenestodoml = as.data.frame(genestodoml)
colnames(genesgenestodoml) = "gene"

# Select features
commontest = colnames(test) %in% genestodoml
test = test[,..commontest]

nombrestest = as.data.frame(colnames(test))
colnames(nombrestest) = "gene"


genesnoaparecen = anti_join(genesgenestodoml,nombrestest)
genesnoaparecen = as.character(genesnoaparecen$gene)

test = readRDS("matrix_ethnicqc_sex_age_notion")

genestodoml = c(genestodoml, "Status")

test = subset(test, test$Status == "FTD")


commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes and the scalated df
x_test <- ftdscalated

modelo_meansftdp = modelo_means

modelo_meansftd = modelo_meansftdp[,-c(170,178)]

modelo_sdftdp = modelo_sd

modelo_sdftdpd = modelo_sdftdp[,-c(170,178)]


x_testprueba = x_test[]-modelo_meansftd[col(x_test[])]

x_testpruebafinal = x_testprueba[]/modelo_sdftdpd[col(x_testprueba[])]

x_test = x_testpruebafinal

x_test = as.data.frame(x_test)

 # add gene name from cdr05
# x_test = cbind(x_test, setNames( lapply(genesnoaparecen, function(x) x=0), genesnoaparecen))

x_test <- as.matrix(x_test )

ftdtoeatmap = as.data.frame(x_test)

# Code status
numeros = as.numeric(test$Status)
 y_test <-replace(numeros, numeros == 2,1)


y_test_ftd = y_test

# Testing preditions
# ==============================================================================
predicciones_test <- predict(modelo, newx = x_test, type = "response" , standarize = F, intercept = F) 

 
 
 predicciones_test_ftd = predicciones_test
 
model40ftd = as.data.frame(y_test_ftd)
model40ftd$predictor = predicciones_test_ftd
model40ftd$model = "40 genes FTD (AUC = )"

names(model40ftd) = c("status", "predictor", "Classifier")
 
 
 model40ftd = rbind(model40ftd,controlsforspe)
 
 model40ftd$Classifier = "40 genes FTD (AUC = 0.64)"

 
 
 longspe40 =rbind(longspe40, model40ftd)


```
 
 
### Figure
 
 
```{r}
 
  longspe40$Classifier = as.factor(longspe40$Classifier)
 
  longspe40$Classifier <- factor(longspe40$Classifier, levels = c("40 genes (AUC = 0.96)","40 genes PD (AUC = 0.65)","40 genes DLB (AUC = 0.85)","40 genes FTD (AUC = 0.64)"))
 

colors =c("#B2DF8A", "#9A031E", "#A1A7B8", "#F1C232")
colors<-setNames(colors[1:nlevels(longspe40$Classifier)], levels(longspe40$Classifier))



## draw plots
basicplot <- ggplot(longspe40, aes(d = status, m = predictor, color = Classifier)) + geom_roc(n.cuts = 0) +   style_roc(theme = theme_bw, xlab = "1-Specificity", ylab = "Sensitivity") + geom_abline(slope = 1, intercept = 0, lty = 2, colour = 'black') + 
    scale_colour_manual(values=colors) 

## calculate auc
# De aqui es de donde coges el AUC para cada uno
calc_auc(basicplot)

basicplot

  ggsave(filename = "roccurvesspecificity40.png",
        plot = basicplot,
        device = "png",
        width =10,
        height = 8,
        dpi = 600)
  
    # PD
  
  preadconfusion = longspe40[longspe40$Classifier == "40 genes PD (AUC = 0.65)",]
  
  
caret::confusionMatrix(data = factor(as.numeric(preadconfusion$predictor>0.5)), reference = factor(preadconfusion$status))
  
    # dlb
  
  preadconfusion = longspe40[longspe40$Classifier == "40 genes DLB (AUC = 0.85)",]
  
  
caret::confusionMatrix(data = factor(as.numeric(preadconfusion$predictor>0.5)), reference = factor(preadconfusion$status))


 # ftd
  
  preadconfusion = longspe40[longspe40$Classifier == "40 genes FTD (AUC = 0.64)",]
  
  
caret::confusionMatrix(data = factor(as.numeric(preadconfusion$predictor>0.5)), reference = factor(preadconfusion$status))

 
```



 
### Figure diff

Anova de diferencia de medias? t.test? 
 
```{r}

longspe40diff = longspe40

longspe40diff1 =longspe40diff[longspe40diff$status == 1,]

adas1 = longspe40diff1[longspe40diff1$Classifier == "40 genes (AUC = 0.96)",]

pdas0 = longspe40diff1[longspe40diff1$Classifier == "40 genes PD (AUC = 0.65)",]

pdas0$status = 0

rocdifpd = rbind(adas1,pdas0)

rocdifpd$Classifier = "40 genes AD vs PD (AUC = 0.85)"

 
dlbas0 = longspe40diff1[longspe40diff1$Classifier == "40 genes DLB (AUC = 0.85)",]

dlbas0$status = 0

rocdifdlb = rbind(adas1,dlbas0)

rocdifdlb$Classifier = "40 genes AD vs DLB (AUC = 0.55)"

ftdas0 = longspe40diff1[longspe40diff1$Classifier == "40 genes FTD (AUC = 0.64)",]

ftdas0$status = 0

rocdifftd = rbind(adas1,ftdas0)

rocdifftd$Classifier = "40 genes AD vs FTD (AUC = 0.86)"


rocdifto = rbind(rocdifpd,rocdifdlb)

rocdifto = rbind(rocdifto,rocdifftd)

 
  rocdifto$Classifier = as.factor(rocdifto$Classifier)
 
  rocdifto$Classifier <- factor(rocdifto$Classifier, levels = c("40 genes AD vs PD (AUC = 0.85)","40 genes AD vs DLB (AUC = 0.55)","40 genes AD vs FTD (AUC = 0.86)"))
 

colors =c("#9A031E", "#A1A7B8", "#F1C232")
colors<-setNames(colors[1:nlevels(rocdifto$Classifier)], levels(rocdifto$Classifier))



## draw plots
basicplot <- ggplot(rocdifto, aes(d = status, m = predictor, color = Classifier)) + geom_roc(n.cuts = 0) +   style_roc(theme = theme_bw, xlab = "1-Specificity", ylab = "Sensitivity") + geom_abline(slope = 1, intercept = 0, lty = 2, colour = 'black') + 
    scale_colour_manual(values=colors) 

## calculate auc
# De aqui es de donde coges el AUC para cada uno
calc_auc(basicplot)

basicplot

  ggsave(filename = "roccurvesspecificityvs40.png",
        plot = basicplot,
        device = "png",
        width =10,
        height = 8,
        dpi = 600)
  
  
  
  # PD diferencias significativas por t.test
  t.test(adas1$predictor, pdas0$predictor)
  
  # DLB diferencias signivicativas
  t.test(adas1$predictor, dlbas0$predictor)
  
  
  # FTD  difenrencias significativas
  t.test(adas1$predictor, ftdas0$predictor)
 
```




## 90 genes



```{r}

genestodoml90 = fread("90genes.csv")

genestodoml90 = genestodoml90[-1,1]
genestodoml90 = genestodoml90$V1

genestodoml = genestodoml90

# Load Matrix
matrix_phase = readRDS("matrix_rlogk99qcADPreclinicalandControls_sex_agep_notion")
train = matrix_phase


# Select features
genestodoml = c(genestodoml, "Status")
commontrain = colnames(train) %in% genestodoml
train = train[,..commontrain]



# Select only genes
x_train <- train[,-1]

# Compute Z score



modelo_means <- as.data.frame(lapply(x_train, mean))
modelo_sd <- as.data.frame(lapply(x_train, sd))



```




### Load AD model PreClinical


```{r}

genestodoml = genestodoml90

genestodoml = c(genestodoml, "Status")

 
# Load Matrix
matrix_phase = readRDS("matrix_rlogk99qcADPreclinicalandControls_sex_agep_notion")
train = matrix_phase

trainconpred = train



# Select features
genestodoml = c(genestodoml, "Status")
commontrain = colnames(train) %in% genestodoml
train = train[,..commontrain]



# Select only genes
x_train <- train[,-1]

# Compute Z score
x_train <- as.data.frame(lapply(x_train, function(x) (x - mean(x))/sd(x) ))
x_train <- as.matrix(x_train )

# Code status
numeros = as.numeric(train$Status)
y_train <-replace(numeros, numeros == 2,0)


y_train_90 = y_train 

# Set seed
set.seed(123)

# Train ridge
cv_error <- cv.glmnet(
  x      = x_train,
  y      = factor(y_train),
  alpha  = 0,
  nfolds = 5, #
  type.measure = "mse",
  standardize  = F,
  family = "binomial",
  intercept = F
)



# Best model lambda
modelo <- glmnet(
  x           = x_train,
  y           = y_train,
  alpha       = 0,
  lambda      = cv_error$lambda.min,
  standardize = F,
  family = "binomial",
  intercept = F
)


# Training predictions
# ==============================================================================
predicciones_train_90 <- predict(modelo, newx = x_train, type = "response", standardize = F)




genestodoml = genestodoml90
genestodoml = c(genestodoml, "Status")
# Load Matrix
test = readRDS("rlogmatrix_allpsold38qcp_notion")


tocorrelationtest = test[,c(1,2,3,4,6)]


# Select features
commontest = colnames(test) %in% genestodoml
test = test[,commontest]




# Select only genes
x_test <- test[,-1]

# Compute Z score
x_test <- as.data.frame(lapply(x_test, function(x) (x - mean(x))/sd(x) ))
x_test <- as.matrix(x_test )

# Code status
numeros = as.numeric(test$Status)
y_test <-replace(numeros, numeros == 1,0)
y_test <-replace(y_test, y_test == 2,1)
# y_test <-replace(numeros, numeros == 1,0)
# y_test <-replace(y_test, y_test == 2,1)


y_test_90 = y_test


# Testing preditions
# ==============================================================================
predicciones_test <- predict(modelo, newx = x_test, type = "response" , standarize = F, intercept = F)

predicciones_test_90 = predicciones_test





# Model90 roc comes from above code (90 genes model)

model90rocte = as.data.frame(y_test_90)
model90rocte$predictor = predicciones_test_90
model90rocte$model = "90 genes (AUC = 0.96)"


names(model90rocte) = c("status", "predictor", "Classifier")



model90roctr = as.data.frame(y_train_90)
model90roctr$predictor = predicciones_train_90
model90roctr$model = "90 genes (AUC = 0.96)"

names(model90roctr) = c("status", "predictor", "Classifier")



model90rocspe = rbind(model90rocte,model90roctr)

# Extract control samples

controlsforspe = model90rocspe[model90rocspe$status == 0,]

  # Add this dataset to the final

    
    
```


### Specificity PD individuals

Scale PD individuals:

```{r}

genestodoml = genestodoml90

# Load Matrix
matrix_phase = readRDS("matrix_rlogk99qcADPreclinicalandControls_sex_agep_notion")
train = matrix_phase


# Select features
genestodoml = c(genestodoml, "Status")
commontrain = colnames(train) %in% genestodoml
train = train[,..commontrain]



# Select only genes
x_train <- train[,-1]



# Para el dftoscale
test = readRDS("matrix_dod_sex_age_notion")

test = subset(test, test$Status == "PD")

commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes
x_test <- test[,-1]


# Esto es una prueba
#pdscaleprueba = scale(x_test, center = F, scale = c(0,1))

pdscalated = scaletwosets(x_train, x_test)


PDmatrix_means <- as.data.frame(lapply(pdscalated, mean))


```


Obtain PD prediction values:  


```{r}

genestodoml = genestodoml90

genestodoml = c(genestodoml, "Status")


test = readRDS("matrix_dod_sex_age_notion")
test = subset(test, test$Status == "PD")

commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes
x_test <- pdscalated


#dfmodelomenas = as.data.frame(modelo_means[col(x_test[])])

x_testprueba = x_test[]-modelo_means[col(x_test[])]

x_testpruebafinal = x_testprueba[]/modelo_sd[col(x_testprueba[])]

x_test = x_testpruebafinal

x_test = as.data.frame(x_test)



# add gene name from cdr05
#x_test = cbind(x_test, setNames( lapply(genesnoaparecen, function(x) x=0), genesnoaparecen) )
x_test <- as.matrix(x_test )



# Code status
numeros = as.numeric(test$Status)
 y_test <-replace(numeros, numeros == 1,0)
 y_test <-replace(y_test, y_test == 2,1)

 y_test_pd = y_test
 
 pdtoeatmap = as.data.frame(x_test)


# Testing preditions
# ==============================================================================
predicciones_test <- predict(modelo, newx = x_test, type = "response" , standarize = F, intercept = F) 

 predicciones_test_pd = predicciones_test
 
 
 
 
 
 
 
model90pd = as.data.frame(y_test_pd)
model90pd$predictor = predicciones_test_pd
model90pd$model = "90 genes PD (AUC = )"

names(model90pd) = c("status", "predictor", "Classifier")
 
 
 model90pd = rbind(model90pd,controlsforspe)
 
 model90pd$Classifier = "90 genes PD (AUC = 0.70)"

 
 
 longspe90 =rbind(model90pd, model90rocspe)
 
 
 longspe90$Classifier = as.factor(longspe90$Classifier)

# longmodelroc$Classifier <- factor(longmodelroc$Classifier, levels = c("90 genes (AUC = 0.90)", "90 genes (AUC = 0.92)", "90 genes (AUC = 0.94)"))

#set colors
ejemplocolores = brewer.pal(12, "Paired")[1:12]

# "#A6CEE3" "#1F78B4" "#B2DF8A" "#33A02C" "#FB9A99" "#E31A1C" "#FDBF6F" "#FF7F00" "#CAB2D6" "#6A3D9A" "#FFFF99" "#B15928"

colors =c("#E31A1C", "#1F78B4")
colors<-setNames(colors[1:nlevels(longspe90$Classifier)], levels(longspe90$Classifier))



## draw plots
basicplot <- ggplot(longspe90, aes(d = status, m = predictor, color = Classifier)) + geom_roc(n.cuts = 0) +   style_roc(theme = theme_bw, xlab = "1-Specificity", ylab = "Sensitivity") + geom_abline(slope = 1, intercept = 0, lty = 2, colour = 'black') + 
    scale_colour_manual(values=colors) 

## calculate auc
# De aqui es de donde coges el AUC para cada uno
calc_auc(basicplot)

basicplot 


# PR curves?? cuando hago esto es menor
# xcurve = pr.curve(scores.class0 = controlsforspe$predictor, scores.class1 = model90pd$predictor, curve=T)
# plot(xcurve)





```



### Specificity DLB individuals

Scale DLB individuals:  


```{r}

genestodoml = genestodoml90

# Load Matrix
matrix_phase = readRDS("matrix_rlogk99qcADPreclinicalandControls_sex_agep_notion")
train = matrix_phase


# Select features
genestodoml = c(genestodoml, "Status")
commontrain = colnames(train) %in% genestodoml
train = train[,..commontrain]

# Select only genes
x_train <- train[,-1]




test = readRDS("matrix_ethnicqc_sex_age_notion")

genestodoml = c(genestodoml, "Status")

test = subset(test, test$Status == "DLB")


commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes
x_test <- test[,-1]


dlbscalated = scaletwosets(x_train, x_test)



```



```{r}



genestodoml = c(genestodoml, "Status")

# Load Matrix
test = readRDS("matrix_ethnicqc_sex_age_notion")


genesgenestodoml = as.data.frame(genestodoml)
colnames(genesgenestodoml) = "gene"

# Select features
commontest = colnames(test) %in% genestodoml
test = test[,..commontest]

nombrestest = as.data.frame(colnames(test))
colnames(nombrestest) = "gene"


genesnoaparecen = anti_join(genesgenestodoml,nombrestest)
genesnoaparecen = as.character(genesnoaparecen$gene)

test = readRDS("matrix_ethnicqc_sex_age_notion")

genestodoml = c(genestodoml, "Status")

test = subset(test, test$Status == "DLB")


commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes and the scalated df
x_test <- dlbscalated

modelo_meansftdp = modelo_means

which(colnames(modelo_meansftdp) %in% genesnoaparecen)  

modelo_meansftd = modelo_meansftdp[,-66]

modelo_sdftdp = modelo_sd

modelo_sdftdpd = modelo_sdftdp[,-66]


x_testprueba = x_test[]-modelo_meansftd[col(x_test[])]

x_testpruebafinal = x_testprueba[]/modelo_sdftdpd[col(x_testprueba[])]

x_test = x_testpruebafinal

x_test = as.data.frame(x_test)

 # add gene name from cdr05
x_test = cbind(x_test, setNames( lapply(genesnoaparecen, function(x) x=0), genesnoaparecen))

x_test <- as.matrix(x_test )

dlbtoeatmap = as.data.frame(x_test)

# Code status
numeros = as.numeric(test$Status)
 y_test <-replace(numeros, numeros == 2,1)


y_test_dlb = y_test

# Testing preditions
# ==============================================================================
predicciones_test <- predict(modelo, newx = x_test, type = "response" , standarize = F, intercept = F) 

 
 predicciones_test_dlb = predicciones_test
 
model90dlb = as.data.frame(y_test_dlb)
model90dlb$predictor = predicciones_test_dlb
model90dlb$model = "90 genes DLB (AUC = )"

names(model90dlb) = c("status", "predictor", "Classifier")
 
 
 model90dlb = rbind(model90dlb,controlsforspe)
 
 model90dlb$Classifier = "90 genes DLB (AUC = 0.89)"

 
 
 longspe90 =rbind(longspe90, model90dlb)

```




### Specificity FTD individuals

Scale FTD individuals:  


```{r}

genestodoml = genestodoml90

# Load Matrix
matrix_phase = readRDS("matrix_rlogk99qcADPreclinicalandControls_sex_agep_notion")
train = matrix_phase


# Select features
genestodoml = c(genestodoml, "Status")
commontrain = colnames(train) %in% genestodoml
train = train[,..commontrain]

# Select only genes
x_train <- train[,-1]




test = readRDS("matrix_ethnicqc_sex_age_notion")

genestodoml = c(genestodoml, "Status")

test = subset(test, test$Status == "FTD")


commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes
x_test <- test[,-1]


ftdscalated = scaletwosets(x_train, x_test)



```



```{r}



genestodoml = c(genestodoml, "Status")

# Load Matrix
test = readRDS("matrix_ethnicqc_sex_age_notion")


genesgenestodoml = as.data.frame(genestodoml)
colnames(genesgenestodoml) = "gene"

# Select features
commontest = colnames(test) %in% genestodoml
test = test[,..commontest]

nombrestest = as.data.frame(colnames(test))
colnames(nombrestest) = "gene"


genesnoaparecen = anti_join(genesgenestodoml,nombrestest)
genesnoaparecen = as.character(genesnoaparecen$gene)

test = readRDS("matrix_ethnicqc_sex_age_notion")

genestodoml = c(genestodoml, "Status")

test = subset(test, test$Status == "FTD")


commontest = colnames(test) %in% genestodoml
test = test[,..commontest]
 

# Select only genes and the scalated df
x_test <- ftdscalated



modelo_meansftdp = modelo_means

which(colnames(modelo_meansftdp) %in% genesnoaparecen)  

modelo_meansftd = modelo_meansftdp[,-66]

modelo_sdftdp = modelo_sd

modelo_sdftdpd = modelo_sdftdp[,-66]


x_testprueba = x_test[]-modelo_meansftd[col(x_test[])]

x_testpruebafinal = x_testprueba[]/modelo_sdftdpd[col(x_testprueba[])]

x_test = x_testpruebafinal

x_test = as.data.frame(x_test)

 # add gene name from cdr05
x_test = cbind(x_test, setNames( lapply(genesnoaparecen, function(x) x=0), genesnoaparecen))

x_test <- as.matrix(x_test )

ftdtoeatmap = as.data.frame(x_test)

# Code status
numeros = as.numeric(test$Status)
 y_test <-replace(numeros, numeros == 2,1)


y_test_ftd = y_test

# Testing preditions
# ==============================================================================
predicciones_test <- predict(modelo, newx = x_test, type = "response" , standarize = F, intercept = F) 

 
 
 predicciones_test_ftd = predicciones_test
 
model90ftd = as.data.frame(y_test_ftd)
model90ftd$predictor = predicciones_test_ftd
model90ftd$model = "90 genes FTD (AUC = )"

names(model90ftd) = c("status", "predictor", "Classifier")
 
 
 model90ftd = rbind(model90ftd,controlsforspe)
 
 model90ftd$Classifier = "90 genes FTD (AUC = 0.87)"

 
 
 longspe90 =rbind(longspe90, model90ftd)


```
 
 
### Figure
 
 
```{r}
 
  longspe90$Classifier = as.factor(longspe90$Classifier)
 
  longspe90$Classifier <- factor(longspe90$Classifier, levels = c("90 genes (AUC = 0.96)","90 genes PD (AUC = 0.70)","90 genes DLB (AUC = 0.89)","90 genes FTD (AUC = 0.87)"))
 

colors =c("#B2DF8A", "#9A031E", "#A1A7B8", "#F1C232")
colors<-setNames(colors[1:nlevels(longspe90$Classifier)], levels(longspe90$Classifier))



## draw plots
basicplot <- ggplot(longspe90, aes(d = status, m = predictor, color = Classifier)) + geom_roc(n.cuts = 0) +   style_roc(theme = theme_bw, xlab = "1-Specificity", ylab = "Sensitivity") + geom_abline(slope = 1, intercept = 0, lty = 2, colour = 'black') + 
    scale_colour_manual(values=colors) 

## calculate auc
# De aqui es de donde coges el AUC para cada uno
calc_auc(basicplot)

basicplot

  ggsave(filename = "roccurvesspecificity90.png",
        plot = basicplot,
        device = "png",
        width =10,
        height = 8,
        dpi = 600)
  
    # PD
  
  preadconfusion = longspe90[longspe90$Classifier == "90 genes PD (AUC = 0.70)",]
  
  
caret::confusionMatrix(data = factor(as.numeric(preadconfusion$predictor>0.5)), reference = factor(preadconfusion$status))
  
    # dlb
  
  preadconfusion = longspe90[longspe90$Classifier == "90 genes DLB (AUC = 0.89)",]
  
  
caret::confusionMatrix(data = factor(as.numeric(preadconfusion$predictor>0.5)), reference = factor(preadconfusion$status))


 # ftd
  
  preadconfusion = longspe90[longspe90$Classifier == "90 genes FTD (AUC = 0.87)",]
  
  
caret::confusionMatrix(data = factor(as.numeric(preadconfusion$predictor>0.5)), reference = factor(preadconfusion$status))

 
```





### Figure specificity alltogether


```{r}

alltogether = rbind(longspe40,longspe90)

alltogether = rbind(alltogether, longspe220)

niveles = c("40 genes PD (AUC = 0.65)", "40 genes DLB (AUC = 0.85)",  "40 genes FTD (AUC = 0.64)", "90 genes PD (AUC = 0.70)" ,"90 genes DLB (AUC = 0.89)",  "90 genes FTD (AUC = 0.87)", "220 genes PD (AUC = 0.72)" ,"220 genes DLB (AUC = 0.88)", "220 genes FTD (AUC = 0.93)")

alltogether2 =filter(alltogether, alltogether$Classifier %in% c(niveles))

alltogether2 = as.data.frame(alltogether2)




alltogether2$Classifier = droplevels(alltogether2$Classifier)

colors =c("#E31A1C", "#1F78B4", "#FB9A99", "#B2DF8A",  "#6A3D9A", "#FDBF6F", "#B15928", "#FF99FF", "#FFAD33")
colors<-setNames(colors[1:nlevels(alltogether2$Classifier)], levels(alltogether2$Classifier))





## draw plots
basicplot <- ggplot(alltogether2, aes(d = status, m = predictor, color = Classifier)) + geom_roc(n.cuts = 0) +   style_roc(theme = theme_bw, xlab = "1-Specificity", ylab = "Sensitivity") + geom_abline(slope = 1, intercept = 0, lty = 2, colour = 'black') + 
    scale_colour_manual(values=colors)  + theme(legend.position = c(0.85, 0.2))


 ggsave(filename = "roccurvesspecificityalltogether.png",
        plot = basicplot,
        device = "png",
        width =10,
        height = 8,
        dpi = 600)


## calculate auc
# De aqui es de donde coges el AUC para cada uno
calc_auc(basicplot)

basicplot


```

 
### Figure diff

Anova de diferencia de medias? t.test? 
 
```{r}

longspe90diff = longspe90

longspe90diff1 =longspe90diff[longspe90diff$status == 1,]

adas1 = longspe90diff1[longspe90diff1$Classifier == "90 genes (AUC = 0.96)",]

pdas0 = longspe90diff1[longspe90diff1$Classifier == "90 genes PD (AUC = 0.70)",]

pdas0$status = 0

rocdifpd = rbind(adas1,pdas0)

rocdifpd$Classifier = "90 genes AD vs PD (AUC = 0.77)"

 
dlbas0 = longspe90diff1[longspe90diff1$Classifier == "90 genes DLB (AUC = 0.89)",]

dlbas0$status = 0

rocdifdlb = rbind(adas1,dlbas0)

rocdifdlb$Classifier = "90 genes AD vs DLB (AUC = 0.65)"

ftdas0 = longspe90diff1[longspe90diff1$Classifier == "90 genes FTD (AUC = 0.87)",]

ftdas0$status = 0

rocdifftd = rbind(adas1,ftdas0)

rocdifftd$Classifier = "90 genes AD vs FTD (AUC = 0.75)"


rocdifto = rbind(rocdifpd,rocdifdlb)

rocdifto = rbind(rocdifto,rocdifftd)

 
  rocdifto$Classifier = as.factor(rocdifto$Classifier)
 
  rocdifto$Classifier <- factor(rocdifto$Classifier, levels = c("90 genes AD vs PD (AUC = 0.77)","90 genes AD vs DLB (AUC = 0.65)","90 genes AD vs FTD (AUC = 0.75)"))
 

colors =c("#9A031E", "#A1A7B8", "#F1C232")
colors<-setNames(colors[1:nlevels(rocdifto$Classifier)], levels(rocdifto$Classifier))



## draw plots
basicplot <- ggplot(rocdifto, aes(d = status, m = predictor, color = Classifier)) + geom_roc(n.cuts = 0) +   style_roc(theme = theme_bw, xlab = "1-Specificity", ylab = "Sensitivity") + geom_abline(slope = 1, intercept = 0, lty = 2, colour = 'black') + 
    scale_colour_manual(values=colors) 

## calculate auc
# De aqui es de donde coges el AUC para cada uno
calc_auc(basicplot)

basicplot

  ggsave(filename = "roccurvesspecificityvs90.png",
        plot = basicplot,
        device = "png",
        width =10,
        height = 8,
        dpi = 600)
  
  
  
  # PD diferencias significativas por t.test
  t.test(adas1$predictor, pdas0$predictor)
  
  # DLB diferencias signivicativas
  t.test(adas1$predictor, dlbas0$predictor)
  
  
  # FTD  difenrencias significativas
  t.test(adas1$predictor, ftdas0$predictor)
 
```




### figure diff alltogether

```{r}
longspe40diff = longspe40

longspe40diff1 =longspe40diff[longspe40diff$status == 1,]

adas1 = longspe40diff1[longspe40diff1$Classifier == "40 genes (AUC = 0.96)",]

pdas0 = longspe40diff1[longspe40diff1$Classifier == "40 genes PD (AUC = 0.65)",]

pdas0$status = 0

rocdifpd = rbind(adas1,pdas0)

rocdifpd$Classifier = "40 genes AD vs PD (AUC = 0.85)"

 
dlbas0 = longspe40diff1[longspe40diff1$Classifier == "40 genes DLB (AUC = 0.85)",]

dlbas0$status = 0

rocdifdlb = rbind(adas1,dlbas0)

rocdifdlb$Classifier = "40 genes AD vs DLB (AUC = 0.55)"

ftdas0 = longspe40diff1[longspe40diff1$Classifier == "40 genes FTD (AUC = 0.64)",]

ftdas0$status = 0

rocdifftd = rbind(adas1,ftdas0)

rocdifftd$Classifier = "40 genes AD vs FTD (AUC = 0.86)"


rocdifto = rbind(rocdifpd,rocdifdlb)

rocdifto = rbind(rocdifto,rocdifftd)

 
  rocdifto$Classifier = as.factor(rocdifto$Classifier)
 
  rocdifto$Classifier <- factor(rocdifto$Classifier, levels = c("40 genes AD vs PD (AUC = 0.85)","40 genes AD vs DLB (AUC = 0.55)","40 genes AD vs FTD (AUC = 0.86)"))
 

rocdif40 =  rocdifto
  
longspe220diff = longspe220

longspe220diff1 =longspe220diff[longspe220diff$status == 1,]

adas1 = longspe220diff1[longspe220diff1$Classifier == "220 genes (AUC = 0.97)",]

pdas0 = longspe220diff1[longspe220diff1$Classifier == "220 genes PD (AUC = 0.72)",]

pdas0$status = 0

rocdifpd = rbind(adas1,pdas0)

rocdifpd$Classifier = "220 genes AD vs PD (AUC = 0.81)"

 
dlbas0 = longspe220diff1[longspe220diff1$Classifier == "220 genes DLB (AUC = 0.88)",]

dlbas0$status = 0

rocdifdlb = rbind(adas1,dlbas0)

rocdifdlb$Classifier = "220 genes AD vs DLB (AUC = 0.69)"

ftdas0 = longspe220diff1[longspe220diff1$Classifier == "220 genes FTD (AUC = 0.93)",]

ftdas0$status = 0

rocdifftd = rbind(adas1,ftdas0)

rocdifftd$Classifier = "220 genes AD vs FTD (AUC = 0.76)"


rocdifto = rbind(rocdifpd,rocdifdlb)

rocdifto = rbind(rocdifto,rocdifftd)

 
  rocdifto$Classifier = as.factor(rocdifto$Classifier)
 
  rocdifto$Classifier <- factor(rocdifto$Classifier, levels = c("220 genes AD vs PD (AUC = 0.81)","220 genes AD vs DLB (AUC = 0.69)","220 genes AD vs FTD (AUC = 0.76)"))
 
rocdif220= rocdifto
  
  
longspe90diff = longspe90

longspe90diff1 =longspe90diff[longspe90diff$status == 1,]

adas1 = longspe90diff1[longspe90diff1$Classifier == "90 genes (AUC = 0.96)",]

pdas0 = longspe90diff1[longspe90diff1$Classifier == "90 genes PD (AUC = 0.70)",]

pdas0$status = 0

rocdifpd = rbind(adas1,pdas0)

rocdifpd$Classifier = "90 genes AD vs PD (AUC = 0.77)"

 
dlbas0 = longspe90diff1[longspe90diff1$Classifier == "90 genes DLB (AUC = 0.89)",]

dlbas0$status = 0

rocdifdlb = rbind(adas1,dlbas0)

rocdifdlb$Classifier = "90 genes AD vs DLB (AUC = 0.65)"

ftdas0 = longspe90diff1[longspe90diff1$Classifier == "90 genes FTD (AUC = 0.87)",]

ftdas0$status = 0

rocdifftd = rbind(adas1,ftdas0)

rocdifftd$Classifier = "90 genes AD vs FTD (AUC = 0.75)"


rocdifto = rbind(rocdifpd,rocdifdlb)

rocdifto = rbind(rocdifto,rocdifftd)

 
  rocdifto$Classifier = as.factor(rocdifto$Classifier)
 
  rocdifto$Classifier <- factor(rocdifto$Classifier, levels = c("90 genes AD vs PD (AUC = 0.77)","90 genes AD vs DLB (AUC = 0.65)","90 genes AD vs FTD (AUC = 0.75)"))
 

rocdif90 = rocdifto
  


rocdifall = rbind(rocdif40, rocdif90)
rocdifall = rbind(rocdifall, rocdif220)

colors =c("#E31A1C", "#1F78B4", "#FB9A99", "#B2DF8A",  "#6A3D9A", "#FDBF6F", "#B15928", "#FF99FF", "#FFAD33")
colors<-setNames(colors[1:nlevels(rocdifall$Classifier)], levels(rocdifall$Classifier))



## draw plots
basicplot <- ggplot(rocdifall, aes(d = status, m = predictor, color = Classifier)) + geom_roc(n.cuts = 0) +   style_roc(theme = theme_bw, xlab = "1-Specificity", ylab = "Sensitivity") + geom_abline(slope = 1, intercept = 0, lty = 2, colour = 'black') + 
    scale_colour_manual(values=colors) + theme(legend.position = c(0.85, 0.2))

## calculate auc
# De aqui es de donde coges el AUC para cada uno


basicplot

  ggsave(filename = "rocdiffall.png",
        plot = basicplot,
        device = "png",
        width =10,
        height = 8,
        dpi = 600)
  
  
  
 
```

